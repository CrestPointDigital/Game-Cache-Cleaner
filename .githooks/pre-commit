#!/usr/bin/env bash
set -euo pipefail

FILES="$(git diff --cached --name-only --diff-filter=ACM)"
[ -z "$FILES" ] && exit 0

PATTERN='(sk_(test|live)_[0-9A-Za-z]{10,}|whsec_[0-9A-Za-z]{10,}|-----BEGIN (RSA |EC |OPENSSH )?PRIVATE KEY-----|aws_secret_access_key|ghp_[0-9A-Za-z]{30,})'
ALLOWLIST=".secret-allowlist"

found=0
while IFS= read -r f; do
  [ -f "$f" ] || continue
  case "$f" in
    .githooks/*|.secret-allowlist|.gitleaks.toml|.github/workflows/*)
      continue
      ;;
  esac
  size=$(wc -c <"$f" 2>/dev/null || echo 0)
  [ "$size" -gt 5242880 ] && continue
  if grep -nE -I "$PATTERN" "$f" | grep -vFf "$ALLOWLIST" 2>/dev/null; then
    found=1
  fi
done <<< "$FILES"

if [ $found -ne 0 ]; then
  echo -e "\nâŒ Secret-like strings detected. Commit blocked."
  exit 1
fi
exit 0
